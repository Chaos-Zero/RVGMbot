name: Deploy RVGM-dev to Hetzner

on:
  push:
    branches: [ dev ]
  workflow_dispatch: {}

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-rvgm-dev
      cancel-in-progress: true

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            APP_DIR="/home/botuser/bots/RVGM-dev"
            REPO_URL="https://github.com/Chaos-Zero/RVGMbot.git" 
            BRANCH="dev"
            PROC="rvgm-dev"

            PARENT_DIR="$(dirname "$APP_DIR")"

            echo "[1/6] Ensure parent dir exists"
            mkdir -p "$PARENT_DIR"

            echo "[2/6] Ensure repo present on $BRANCH (without nuking cwd)"
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "→ Fresh clone to $APP_DIR"
              rm -rf "$APP_DIR"
              git clone --branch "$BRANCH" --single-branch "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "[3/6] Sync to origin/$BRANCH"
            git fetch --all --prune
            # ensure we are on the right branch locally
            if ! git rev-parse --abbrev-ref HEAD | grep -qx "$BRANCH"; then
              git checkout -B "$BRANCH"
            fi
            git reset --hard "origin/$BRANCH"

            echo "[4/6] Install deps (skip if unchanged)"
            set +e
            npm config set fund false
            npm config set audit false
            npm config set progress false
            npm config set fetch-timeout 120000
            npm config set fetch-retries 2
            npm config set fetch-retry-maxtimeout 240000
            set -e

            export CI=true NO_UPDATE_NOTIFIER=1

            MANIFEST="package-lock.json"
            [ -f package-lock.json ] || MANIFEST="package.json"
            CUR_HASH="$(sha256sum "$MANIFEST" | awk '{print $1}')"
            LAST_HASH="$(cat .last_deps_hash 2>/dev/null || echo '')"

            NEED_INSTALL=0
            [ ! -d node_modules ] && NEED_INSTALL=1
            [ "$CUR_HASH" != "$LAST_HASH" ] && NEED_INSTALL=1

            if [ "$NEED_INSTALL" -eq 1 ]; then
              echo "→ Installing deps with npm (manifest: $MANIFEST)"

              set +e
              if [ -f package-lock.json ]; then
                npm ci --omit=dev --no-audit --no-fund
              else
                npm i --omit=dev --no-audit --no-fund
              fi
              NPM_STATUS=$?
              set -e

              if [ "$NPM_STATUS" -ne 0 ]; then
                echo "[warning] npm install failed with status $NPM_STATUS" >&2

                if [ -d node_modules ]; then
                  echo "[info] Continuing deploy using existing node_modules directory" >&2
                else
                  echo "[warning] No node_modules found; app may fail at runtime, but continuing deploy anyway" >&2
                fi

                # Do NOT update .last_deps_hash – deps are not guaranteed to match manifest
              else
                echo "$CUR_HASH" > .last_deps_hash
              fi
            else
              echo "→ No dependency changes detected; skipping npm install"
            fi
            echo "[5/6] Reload pm2 process: $PROC"
            if command -v pm2 >/dev/null 2>&1; then
              set +e
              pm2 reload "$PROC"
              PM2_STATUS=$?
              set -e

              if [ "$PM2_STATUS" -ne 0 ]; then
                echo "[warning] pm2 reload '$PROC' failed with status $PM2_STATUS; continuing" >&2
              else
                echo "[info] pm2 reload '$PROC' successful"
              fi
            else
              echo "[warning] pm2 command not found on remote host; skipping reload" >&2
            fi
