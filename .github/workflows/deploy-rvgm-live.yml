name: Deploy RVGM-live to Hetzner

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  deploy-live:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-rvgm-live
      cancel-in-progress: true

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            APP_DIR="/home/botuser/bots/RVGM-live"
            REPO_URL="https://github.com/Chaos-Zero/RVGMbot.git" 
            BRANCH="master"
            PROC="rvgm-live"

            PARENT_DIR="$(dirname "$APP_DIR")"

            echo "[1/6] Ensure parent dir exists"
            mkdir -p "$PARENT_DIR"

            echo "[2/6] Ensure repo present on $BRANCH (without nuking cwd)"
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "→ Fresh clone to $APP_DIR"
              rm -rf "$APP_DIR"
              git clone --branch "$BRANCH" --single-branch "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "[3/6] Sync to origin/$BRANCH"
            # If this repo was originally cloned as a single-branch (e.g. master),
            # origin/$BRANCH may not exist locally. Ensure we fetch the desired branch.
            git remote set-branches origin "$BRANCH"
            git fetch origin --prune

            if ! git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
              echo "[warn] origin/$BRANCH not found after initial fetch. Expanding fetch refspec..."
              git remote set-branches origin "*"
              git fetch origin --prune
            fi

            if ! git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
              echo "[error] origin/$BRANCH still missing. Check if the branch exists on remote." >&2
              git branch -r
              exit 1
            fi

            # ensure we are on the right branch locally
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            echo "[4/6] Install deps (skip if unchanged)"
            MANIFEST=""
            if [ -f package-lock.json ]; then
              MANIFEST="package-lock.json"
            elif [ -f package.json ]; then
              MANIFEST="package.json"
            fi

            NEED_INSTALL=0
            if [ -n "$MANIFEST" ] && command -v npm >/dev/null 2>&1; then
              npm config set fund false           >/dev/null 2>&1 || true
              npm config set audit false          >/dev/null 2>&1 || true
              npm config set progress false       >/dev/null 2>&1 || true
              npm config set fetch-timeout 120000 >/dev/null 2>&1 || true
              npm config set fetch-retries 2      >/dev/null 2>&1 || true
              npm config set fetch-retry-maxtimeout 240000 >/dev/null 2>&1 || true
              export CI=true NO_UPDATE_NOTIFIER=1

              HASH_CMD=""
              if command -v sha256sum >/dev/null 2>&1; then
                HASH_CMD="sha256sum"
              elif command -v shasum >/dev/null 2>&1; then
                HASH_CMD="shasum -a 256"
              fi

              if [ -n "$HASH_CMD" ]; then
                CUR_HASH="$($HASH_CMD "$MANIFEST" 2>/dev/null | awk '{print $1}' || true)"
                LAST_HASH="$(cat .last_deps_hash 2>/dev/null || echo '')"

                [ ! -d node_modules ] && NEED_INSTALL=1
                [ -n "$CUR_HASH" ] && [ "$CUR_HASH" != "$LAST_HASH" ] && NEED_INSTALL=1
              else
                echo "[warning] No sha256sum/shasum available; installing deps only if node_modules is missing" >&2
                [ ! -d node_modules ] && NEED_INSTALL=1
              fi
            else
              if [ -z "$MANIFEST" ]; then
                echo "[info] No package-lock.json or package.json; skipping npm install"
              else
                echo "[warning] npm not found; skipping dependency install" >&2
              fi
            fi

            if [ "$NEED_INSTALL" -eq 1 ]; then
              echo "→ Installing deps with npm (manifest: $MANIFEST)"

              if [ -f package-lock.json ]; then
                # allow npm to fail without killing the whole script
                set +e
                npm ci --omit=dev --no-audit --no-fund
                NPM_STATUS=$?
                set -e
              else
                set +e
                npm i --omit=dev --no-audit --no-fund
                NPM_STATUS=$?
                set -e
              fi

              if [ "$NPM_STATUS" -ne 0 ]; then
                echo "[warning] npm install failed with status $NPM_STATUS" >&2

                # If we *don't* have node_modules, we can't run → hard fail
                if [ ! -d node_modules ]; then
                  echo "[error] No existing node_modules to fall back to; aborting deploy" >&2
                  exit "$NPM_STATUS"
                fi

                echo "[info] Continuing deploy using existing node_modules directory"
                # NOTE: don't update .last_deps_hash, since deps don't match manifest
              else
                # only mark deps as “up-to-date” when install succeeded
                echo "$CUR_HASH" > .last_deps_hash
              fi
            else
              echo "→ No dependency changes detected; skipping npm install"
            fi

            echo "[5/6] Reload pm2 process: $PROC via bash -lc"
            bash -lc '
              APP_DIR="'"$APP_DIR"'"
              PROC="'"$PROC"'"

              cd "$APP_DIR" || {
                echo "[warning] (pm2) could not cd to $APP_DIR; skipping reload" >&2
                exit 0
              }

              if ! command -v pm2 >/dev/null 2>&1; then
                echo "[warning] pm2 not found in login shell; skipping reload" >&2
                exit 0
              fi

              echo "[info] Using pm2 at: $(command -v pm2)"
              pm2 reload "$PROC" || {
                echo "[warning] pm2 reload \"$PROC\" failed; trying pm2 start" >&2
                pm2 start ecosystem.config.js --only "$PROC" --update-env || echo "[warning] pm2 start \"$PROC\" also failed" >&2
              }
              pm2 save || echo "[warning] pm2 save failed" >&2
              pm2 list || echo "[warning] pm2 list failed" >&2
            '
