name: Deploy RVGM-live to Hetzner

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  deploy-live:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-rvgm-live
      cancel-in-progress: true

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            APP_DIR="/home/botuser/bots/RVGM-live"
            REPO_URL="https://github.com/Chaos-Zero/RVGMbot.git"   # <-- change
            BRANCH="master"
            PROC="rvgm-live"

            echo "[1/6] Ensure app dir exists"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            echo "[2/6] Ensure repo present on $BRANCH"
            if [ ! -d .git ]; then
              echo "Cloning fresh..."
              rm -rf "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
              cd "$APP_DIR"
            fi

            git fetch --all --prune
            git checkout "$BRANCH" || git checkout -b "$BRANCH"
            git reset --hard "origin/$BRANCH"

            echo "[3/6] Harden npm + timeouts"
            npm config set fund false
            npm config set audit false
            npm config set progress false
            npm config set fetch-timeout 120000
            npm config set fetch-retries 2
            npm config set fetch-retry-maxtimeout 240000
            export CI=true
            export NO_UPDATE_NOTIFIER=1

            echo "[4/6] Install dependencies (skip if unchanged)"
            MANIFEST="package-lock.json"
            if [ ! -f package-lock.json ]; then MANIFEST="package.json"; fi
            CUR_HASH="$(sha256sum "$MANIFEST" | awk '{print $1}')"
            LAST_HASH="$(cat .last_deps_hash 2>/dev/null || echo '')"

            if [ ! -d node_modules ]; then
              echo "→ node_modules missing; will install"
              NEED_INSTALL=1
            elif [ "$CUR_HASH" != "$LAST_HASH" ]; then
              echo "→ Dependency manifest changed; will install"
              NEED_INSTALL=1
            else
              NEED_INSTALL=0
              echo "→ No dependency changes detected; skipping npm install"
            fi

            if [ "$NEED_INSTALL" -eq 1 ]; then
              if [ -f package-lock.json ]; then
                timeout 15m npm ci --omit=dev --no-audit --no-fund
              else
                timeout 15m npm i --omit=dev --no-audit --no-fund
              fi
              echo "$CUR_HASH" > .last_deps_hash
            fi

            echo "[5/6] Reload PM2"
            pm2 reload "$PROC" || pm2 start /home/botuser/ecosystem.config.js --only "$PROC" --update-env
            pm2 save

            echo "[6/6] Show PM2 status"
            pm2 list
